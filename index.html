<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeMountain - Hiker Safety</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f8f4;
      color: #222;
    }
    header {
      background: linear-gradient(90deg, #388e3c 70%, #8bc34a 100%);
      color: white;
      padding: 2em 1em 1em;
      text-align: center;
      box-shadow: 0 2px 8px #0002;
    }
    nav {
      background: #f8fffa;
      padding: 1em 0.5em;
      text-align: center;
      box-shadow: 0 2px 6px #0001;
    }
    nav a {
      margin: 0 1em;
      color: #387d34;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1em;
      transition: color 0.2s;
    }
    nav a:hover,
    nav a:focus {
      color: #ff9800;
    }
    #map {
      height: 70vh;
      border-radius: 12px;
      margin: 10px auto;
      width: 96%;
      box-shadow: 0 4px 10px #0002;
    }
    #salva {
      margin: 14px auto 6px auto;
      padding: 10px 32px;
      background-color: #2e7031;
      color: white;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-size: 1.05em;
      box-shadow: 0 2px 6px #0001;
      display: block;
      transition: background 0.25s;
    }
    #salva:hover {
      background: #43a047;
    }
    section#info {
      max-width: 700px;
      background: #fff;
      margin: 2em auto;
      border-radius: 10px;
      padding: 1.5em;
      box-shadow: 0 2px 18px #0001;
      color: #29552a;
    }
    .guide {
      background: #e8f5e9;
      border-left: 5px solid #ffd600;
      color: #29552a;
      margin: 18px 7%;
      padding: 13px 18px;
      border-radius: 7px;
      font-size: 1em;
      box-shadow: 0 2px 8px #0001;
    }
    #modal-nome-zona {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(45, 70, 38, 0.18);
      backdrop-filter: blur(2px);
      align-items: center;
      justify-content: center;
    }
    #modal-nome-zona.active {
      display: flex;
    }
    #modal-content-nomezona {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 26px #0004;
      padding: 30px 32px 22px;
      min-width: 340px;
      text-align: center;
      border: 2px solid #33ad69;
      animation: modalpop 0.22s;
    }
    @keyframes modalpop {
      0% {
        opacity: 0;
        transform: scale(1.09);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    #modal-content-nomezona input,
    #modal-content-nomezona select {
      font-size: 1em;
      padding: 9px 8px;
      width: 98%;
      margin-bottom: 11px;
      border-radius: 7px;
      border: 1.2px solid #86d6ba;
    }
    #modal-content-nomezona button {
      padding: 7px 20px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 7px;
      font-size: 1em;
    }
    #btn-nome-conferma {
      background: #299d42;
      color: white;
    }
    #btn-nome-cancella {
      background: #e7e7e7;
      color: #25622d;
    }
    .btn-elimina-zona {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .btn-elimina-zona:hover {
      background: #b71c1c;
    }
    .btn-edit-zona {
      background: #2196f3;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
      margin-right: 6px;
    }
    .btn-edit-zona:hover {
      background: #1976d2;
    }
  </style>
</head>
<body>
  <header>
    <h1>SafeMountain</h1>
    <p>Map-based safety system for hikers</p>
  </header>

  <nav>
    <a href="#">Home</a>
    <a href="#mappa">Map</a>
    <a href="#info">Project Info</a>
  </nav>

  <section id="mappa">
    <div class="guide">
      <strong>How does it work?</strong><br />
      1. Draw the dangerous zones on the map with the tools on the left.<br />
      2. Click "Save coordinates" to export the areas online.<br />
      <span style="color: #d32f2f">Warning:</span> The data must be verified and approved by the responsible authority.
    </div>
    <button id="salva">Save coordinates</button>
    <div id="map"></div>

    <div
      id="elenco-zone"
      style="max-width: 720px; margin: 22px auto; box-shadow: 0 2px 12px #0001; border-radius: 8px; background: white"
    >
      <table style="width: 100%; border-collapse: collapse">
        <thead>
          <tr style="background: #e8f5e9">
            <th style="padding: 9px 2px">Zone Name</th>
            <th>Type</th>
            <th>Area</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="zone-tbody"></tbody>
      </table>
    </div>
  </section>

  <section id="info">
    <h2>Project Information</h2>
    <p>
      SafeMountain is a web application that enhances outdoor safety by enabling authorized
      organizations to create, update, and manage hazardous zones on interactive maps.
      These zones are automatically exported as GeoJSON data to an online service.
      The dedicated GPS device carried by hikers seamlessly connects to the internet whenever a connection
      is available and automatically downloads the latest hazard coordinates, requiring no manual intervention.
      This proactive system provides real-time alerts with curated, up-to-date safety information tailored for outdoor enthusiasts.
    </p>
  </section>

  <div id="modal-nome-zona">
    <div id="modal-content-nomezona">
      <div class="titolo">Define this zone</div>
      <input id="input-nome-zona" type="text" maxlength="50" placeholder="Zone name" /><br />
      <select id="tipo-zona">
        <option value="">Zone type...</option>
        <option value="Ski Slope">Ski Slope</option>
        <option value="Tourist trail">Tourist trail</option>
        <option value="Hiking trail">Hiking trail</option>
        <option value="Exposed section/risk of falling">Exposed section/risk of falling</option>
        <option value="Expert hiking trail">Expert hiking trail</option>
        <option value="Difficult crossings">Difficult crossings</option>
        <option value="General hazard">General hazard</option>
      </select><br />
      <input id="input-comprensorio" type="text" maxlength="50" placeholder="Area / Region" /><br />
      <button id="btn-nome-conferma">OK</button>
      <button id="btn-nome-cancella">Cancel</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    let allGeoJSON = [];
    let areaPending = null;
    let layerIdCounter = 0;
    let editingLayerId = null;

    window.allGeoJSON = allGeoJSON;

    function aggiornaTabellaZone(statusArr) {
      const tbody = document.getElementById('zone-tbody');
      tbody.innerHTML = '';
      statusArr.forEach((row) => {
        tbody.innerHTML += `
          <tr>
            <td style="padding:7px 2px;">${row.nome}</td>
            <td>${row.tipo}</td>
            <td>${row.comprensorio}</td>
            <td>
              <span style="color:${row.stato === 'Online' ? '#2e7031' : '#d32f2f'};font-weight:bold;">
                ${row.stato}
              </span>
            </td>
            <td>
              <button class="btn-edit-zona" data-layer-id="${row.layerId}" style="margin-right:6px;">Edit</button>
              <button class="btn-elimina-zona" data-layer-id="${row.layerId}">Delete</button>
            </td>
          </tr>
        `;
      });

      document.querySelectorAll('.btn-elimina-zona').forEach((btn) => {
        btn.addEventListener('click', function () {
          const layerId = parseInt(this.getAttribute('data-layer-id'));
          eliminaZona(layerId);
        });
      });

      document.querySelectorAll('.btn-edit-zona').forEach((btn) => {
        btn.addEventListener('click', function () {
          const layerId = parseInt(this.getAttribute('data-layer-id'));
          openEditModal(layerId);
        });
      });
    }
    window.aggiornaTabellaZone = aggiornaTabellaZone;

    function eliminaZona(layerId) {
      drawnItems.eachLayer(function (layer) {
        if (layer._customId === layerId) {
          drawnItems.removeLayer(layer);
        }
      });

      const index = allGeoJSON.findIndex((item) => item._customId === layerId);
      if (index > -1) {
        allGeoJSON.splice(index, 1);
      }

      window.aggiornaTabellaZone(
        allGeoJSON.map((z) => ({
          nome: z.properties.name || '-',
          tipo: z.properties.tipo || '-',
          comprensorio: z.properties.comprensorio || '-',
          stato: 'Pending',
          layerId: z._customId,
        }))
      );

      alert('Zone deleted successfully.');
    }

    function openNomeModal(callback, zoneData = null) {
      const modal = document.getElementById('modal-nome-zona');
      modal.classList.add('active');

      const inputNome = document.getElementById('input-nome-zona');
      const inputTipo = document.getElementById('tipo-zona');
      const inputCompr = document.getElementById('input-comprensorio');

      if (zoneData) {
        inputNome.value = zoneData.nome || '';
        inputTipo.value = zoneData.tipo || '';
        inputCompr.value = zoneData.comprensorio || '';
      } else {
        inputNome.value = '';
        inputTipo.value = '';
        inputCompr.value = '';
      }
      inputNome.focus();

      const btnOk = document.getElementById('btn-nome-conferma');
      const btnCancel = document.getElementById('btn-nome-cancella');

      btnOk.onclick = () => {
        let nome = inputNome.value.trim();
        let tipo = inputTipo.value.trim();
        let compr = inputCompr.value.trim();
        closeNomeModal();
        callback({ nome, tipo, compr });
      };
      btnCancel.onclick = () => {
        closeNomeModal();
        callback(null);
      };
      inputNome.onkeydown = function (e) {
        if (e.key === 'Enter') btnOk.click();
        if (e.key === 'Escape') btnCancel.click();
      };
    }

    function closeNomeModal() {
      document.getElementById('modal-nome-zona').classList.remove('active');
    }

    function openEditModal(layerId) {
      const zoneIndex = allGeoJSON.findIndex((z) => z._customId === layerId);
      if (zoneIndex === -1) return alert('Zone not found');

      const zone = allGeoJSON[zoneIndex];
      editingLayerId = layerId;

      openNomeModal(
        (updatedData) => {
          if (updatedData) {
            // Update GeoJSON object in allGeoJSON array
            zone.properties.name = updatedData.nome;
            zone.properties.tipo = updatedData.tipo;
            zone.properties.comprensorio = updatedData.compr;

            // Update layer popup and properties on the map layer
            drawnItems.eachLayer((layer) => {
              if (layer._customId === layerId) {
                layer.feature.properties.name = updatedData.nome;
                layer.feature.properties.tipo = updatedData.tipo;
                layer.feature.properties.comprensorio = updatedData.compr;
                layer.bindPopup(
                  `<b>${updatedData.nome}</b><br>` +
                    (updatedData.tipo ? `<i>Type:</i> ${updatedData.tipo}<br>` : '') +
                    (updatedData.compr ? `<i>Area:</i> ${updatedData.compr}` : '')
                );
              }
            });

            // Mark zone as pending on update
            window.aggiornaTabellaZone(
              allGeoJSON.map((z) => ({
                nome: z.properties.name || '-',
                tipo: z.properties.tipo || '-',
                comprensorio: z.properties.comprensorio || '-',
                stato: 'Pending',
                layerId: z._customId,
              }))
            );

            alert('Zone updated. Remember to save the coordinates.');
            editingLayerId = null;
          } else {
            editingLayerId = null;
          }
        },
        {
          nome: zone.properties.name,
          tipo: zone.properties.tipo,
          comprensorio: zone.properties.comprensorio,
        }
      );
    }

    const map = L.map('map').setView([42.5, 13.4], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap',
    }).addTo(map);
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#d32f2f' } },
        rectangle: true,
        polyline: false,
        circle: false,
        marker: false,
        circlemarker: false,
      },
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
      areaPending = e.layer;
      openNomeModal(function (datiZona) {
        if (datiZona && datiZona.nome) {
          const customId = layerIdCounter++;
          areaPending._customId = customId;

          areaPending.feature = areaPending.feature || {};
          areaPending.feature.properties = areaPending.feature.properties || {};
          areaPending.feature.properties.name = datiZona.nome;
          areaPending.feature.properties.tipo = datiZona.tipo;
          areaPending.feature.properties.comprensorio = datiZona.compr;
          areaPending.bindPopup(
            `<b>${datiZona.nome}</b><br>` +
              (datiZona.tipo ? `<i>Type:</i> ${datiZona.tipo}<br>` : '') +
              (datiZona.compr ? `<i>Area:</i> ${datiZona.compr}` : '')
          );

          drawnItems.addLayer(areaPending);
          const geojson = areaPending.toGeoJSON();
          geojson.properties = geojson.properties || {};
          geojson.properties.name = datiZona.nome;
          geojson.properties.tipo = datiZona.tipo;
          geojson.properties.comprensorio = datiZona.compr;
          geojson._customId = customId;
          allGeoJSON.push(geojson);

          window.aggiornaTabellaZone(
            allGeoJSON.map((z) => ({
              nome: z.properties.name || '-',
              tipo: z.properties.tipo || '-',
              comprensorio: z.properties.comprensorio || '-',
              stato: 'Pending',
              layerId: z._customId,
            }))
          );

          alert('Zone added. Remember to save the coordinates.');
        }
        areaPending = null;
      });
    });
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://agmrlgybyqkilqumgnco.supabase.co';
    const supabaseKey =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnbXJsZ3lieXFraWxxdW1nbmNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNjE0MTYsImV4cCI6MjA3NTgzNzQxNn0.XY-HharpF3mXEpVsYVYq2NIecvl642ZywZRke6Erf-w';
    const bucketName = 'geojson';
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function uploadToSupabase(fileName, fileData) {
      const { data, error } = await supabase
        .storage
        .from(bucketName)
        .upload(fileName, new Blob([fileData], { type: 'application/json' }), { upsert: true });
      if (error) throw error;
      const { data: publicUrlData } = supabase.storage.from(bucketName).getPublicUrl(fileName);
      return publicUrlData.publicUrl;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('salva').addEventListener('click', async () => {
        if (window.allGeoJSON.length === 0) {
          alert('You have not drawn any zones yet.');
          return;
        }
        const geojsonFeatureCollection = {
          type: 'FeatureCollection',
          features: window.allGeoJSON,
        };
        const fileName = 'danger_zones.geojson';
        const fileData = JSON.stringify(geojsonFeatureCollection);
        try {
          const url = await uploadToSupabase(fileName, fileData);
          alert('File uploaded! Public link to use on Arduino:\n' + url);
          window.aggiornaTabellaZone(
            window.allGeoJSON.map((z) => ({
              nome: z.properties.name || '-',
              tipo: z.properties.tipo || '-',
              comprensorio: z.properties.comprensorio || '-',
              stato: 'Online',
              layerId: z._customId,
            }))
          );
        } catch (e) {
          alert('Upload error: ' + e.message);
        }
      });
    });
  </script>
</body>
</html>












